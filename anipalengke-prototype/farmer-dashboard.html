<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmer Dashboard Â· AniPalengke</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/components.css" />
</head>
<body>
  <header class="site-header"></header>
  <main class="main">
    <div class="container">
      <div class="section">
        <h2>Farmer Dashboard</h2>
        <div class="dashboard-grid">
          <div class="kpi-card"><div class="kpi-title">My Products</div><div class="kpi-value" id="kpi-products">0</div></div>
          <div class="kpi-card"><div class="kpi-title">Orders received</div><div class="kpi-value" id="kpi-orders">0</div></div>
          <div class="kpi-card"><div class="kpi-title">Pending deliveries</div><div class="kpi-value" id="kpi-deliveries">0</div></div>
        </div>
      </div>
      <div class="section card">
        <div class="card-header">Manage My Products</div>
        <div class="card-body">
          <div class="actions">
            <button class="btn btn-primary" id="add-product-btn">Add Product</button>
          </div>
          <div class="spacer"></div>
          <div class="card-grid" id="my-products"></div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/main.js"></script>
  <script src="js/users.js"></script>
  <script src="js/products.js"></script>
  <script src="js/orders.js"></script>
  <script>
    const { requireRole, openModal, closeModal, formatCurrency, showToast } = AniP;
    const user = requireRole('farmer');

    function renderMyProducts(){
      const products = ProductsStore.getProducts().filter(p => p.farmerId === user.id);
      document.getElementById('kpi-products').textContent = products.length;
      const grid = document.getElementById('my-products');
      grid.innerHTML = products.map(p => `
        <article class="product-card">
          <div class="card-media"><img src="${p.image}" alt="${p.name}" style="width:100%;height:100%;object-fit:cover;"/></div>
          <div class="card-content">
            <div class="card-title">${p.name}</div>
            <div class="card-meta"><span>${formatCurrency(p.price)}</span><span>Stock: ${p.stock}</span></div>
          </div>
          <div class="card-actions">
            <button class="btn btn-secondary" data-edit="${p.id}">Edit</button>
            <button class="btn btn-danger" data-del="${p.id}">Delete</button>
          </div>
        </article>`).join('') || '<div class="empty">No products yet</div>';

      grid.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => openEditProduct(btn.getAttribute('data-edit'))));
      grid.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => { ProductsStore.deleteProduct(btn.getAttribute('data-del')); renderMyProducts(); }));
    }

    function openAddProduct(){
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <form id="product-form" class="form">
          <div class="grid grid-2">
            <div class="form-row"><label class="label">Name</label><input class="input" name="name" required/></div>
            <div class="form-row"><label class="label">Price (PHP)</label><input class="input" name="price" type="number" min="0" required/></div>
          </div>
          <div class="grid grid-2">
            <div class="form-row"><label class="label">Stock</label><input class="input" name="stock" type="number" min="0" required/></div>
            <div class="form-row"><label class="label">Image URL</label><input class="input" name="image" placeholder="assets/placeholder.jpg"/></div>
          </div>
          <div class="modal-footer" style="padding:0; border-top:none;">
            <button class="btn btn-secondary" type="button" id="cancel">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>`;
      openModal({ title: 'Add Product', content: wrapper });
      wrapper.querySelector('#cancel').addEventListener('click', closeModal);
      wrapper.querySelector('#product-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.currentTarget).entries());
        ProductsStore.addProduct(data);
        closeModal();
        showToast({ title: 'Product added', message: data.name });
        renderMyProducts();
      });
    }

    function openEditProduct(id){
      const p = ProductsStore.getProducts().find(x => x.id === id);
      if (!p) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <form id="product-form" class="form">
          <div class="grid grid-2">
            <div class="form-row"><label class="label">Name</label><input class="input" name="name" required value="${p.name}"/></div>
            <div class="form-row"><label class="label">Price (PHP)</label><input class="input" name="price" type="number" min="0" required value="${p.price}"/></div>
          </div>
          <div class="grid grid-2">
            <div class="form-row"><label class="label">Stock</label><input class="input" name="stock" type="number" min="0" required value="${p.stock}"/></div>
            <div class="form-row"><label class="label">Image URL</label><input class="input" name="image" value="${p.image}"/></div>
          </div>
          <div class="modal-footer" style="padding:0; border-top:none;">
            <button class="btn btn-secondary" type="button" id="cancel">Cancel</button>
            <button class="btn btn-primary" type="submit">Update</button>
          </div>
        </form>`;
      openModal({ title: 'Edit Product', content: wrapper });
      wrapper.querySelector('#cancel').addEventListener('click', closeModal);
      wrapper.querySelector('#product-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.currentTarget).entries());
        ProductsStore.updateProduct(id, { ...data, price: Number(data.price), stock: Number(data.stock) });
        closeModal();
        showToast({ title: 'Product updated', message: data.name });
        renderMyProducts();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderMyProducts();
      document.getElementById('add-product-btn').addEventListener('click', openAddProduct);

      // KPIs for orders and deliveries
      const u = AniP.getCurrentUser();
      const orders = OrdersStore.getOrders().filter(o => o.items.some(i => i.farmerId === u.id));
      document.getElementById('kpi-orders').textContent = orders.length;
      document.getElementById('kpi-deliveries').textContent = 0;
    });
  </script>
</body>
</html>
