{% extends 'core/base.html' %}

{% block title %}Account Settings · AniPalengke{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container settings-container">
    <div class="section-header">
        <h2>Account Settings</h2>
        <p class="muted">Manage your profile and security preferences.</p>
    </div>

    <div class="settings-grid">
        <!-- Profile Information -->
        <div class="card">
            <div class="card-header">
                <h3>Profile Information</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_profile">
                    
                    <div class="profile-avatar-section">
                        <div class="profile-avatar">
                            {% if user_data.profile_image %}
                                <img src="{{ user_data.profile_image }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <span style="font-size: 2rem; color: var(--gray-500); font-weight: bold;">{{ user_data.username|slice:":1"|upper }}</span>
                            {% endif %}
                        </div>
                        <label for="profile_image" class="btn btn-ghost btn-sm" style="cursor: pointer;">
                            Change Photo
                            <input type="file" id="profile_image" name="profile_image" style="display: none;" accept="image/*" onchange="this.form.submit()">
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="name" class="label">Full Name</label>
                        <input type="text" id="name" name="name" class="input" value="{{ user_data.name|default:user_data.username }}" required>
                    </div>

                    <div class="form-group">
                        <label for="username" class="label">Username</label>
                        <input type="text" id="username" name="username" class="input" value="{{ user_data.username }}" required>
                    </div>

                    <div class="form-group">
                        <label for="email" class="label">Email Address</label>
                        <input type="email" id="email" name="email" class="input" value="{{ user_data.email }}" required>
                    </div>

                    <div class="form-group">
                        <label for="location" class="label">Location</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="location" name="location" class="input" value="{{ user_data.location|default:'' }}" placeholder="e.g. Bulacan, Pampanga" style="flex: 1;">
                            <button type="button" id="getLocationBtn" class="btn btn-ghost" title="Use my current location">
                                <i class="fa-solid fa-location-crosshairs"></i>
                            </button>
                        </div>
                        <div id="map" style="height: 300px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;"></div>
                        <small class="muted">Drag the marker to pinpoint your exact location.</small>
                    </div>

                    <div class="form-group">
                        <label class="label">Role</label>
                        <input type="text" class="input" value="{{ user_data.role|title }}" disabled style="background: var(--gray-100);">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- Security -->
        <div class="card">
            <div class="card-header">
                <h3>Change Password</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_password">
                    
                    <div class="form-group">
                        <label for="old_password" class="label">Current Password</label>
                        <input type="password" id="old_password" name="old_password" class="input" required>
                    </div>

                    <div class="form-group">
                        <label for="new_password" class="label">New Password</label>
                        <input type="password" id="new_password" name="new_password" class="input" required>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" class="label">Confirm New Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" class="input" required>
                    </div>

                    <button type="submit" class="btn btn-secondary" style="width: 100%;">Update Password</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize Map
    // Default to Manila
    let map = L.map('map').setView([14.5995, 120.9842], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let marker = L.marker([14.5995, 120.9842], {draggable: true}).addTo(map);

    // Function to update input from coordinates
    function updateAddressFromCoords(lat, lng) {
        const input = document.getElementById('location');
        // Use OpenStreetMap Nominatim for reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                const address = data.address;
                let formatted = data.display_name;
                if (address) {
                    // Construct a cleaner address
                    const parts = [
                        address.road,
                        address.suburb || address.neighborhood,
                        address.city || address.town || address.village,
                        address.state || address.province
                    ];
                    formatted = parts.filter(Boolean).join(', ');
                }
                input.value = formatted;
            })
            .catch(err => console.error('Geocoding error:', err));
    }

    // Update on marker drag
    marker.on('dragend', function(e) {
        const position = marker.getLatLng();
        updateAddressFromCoords(position.lat, position.lng);
    });

    // Get Current Location Button
    document.getElementById('getLocationBtn').addEventListener('click', function() {
        const btn = this;
        
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Update Map
                map.setView([lat, lng], 16);
                marker.setLatLng([lat, lng]);
                
                // Update Input
                updateAddressFromCoords(lat, lng);
                
                btn.innerHTML = originalContent;
                btn.disabled = false;
            },
            (error) => {
                alert('Unable to retrieve your location. Please allow location access.');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        );
    });
    
    // Try to set map location if input has value (Simple check)
    // This is a basic implementation. For better results, we'd need to forward geocode the input value on load.
    // For now, we'll just leave it at default or let the user set it.
</script>
{% endblock %}